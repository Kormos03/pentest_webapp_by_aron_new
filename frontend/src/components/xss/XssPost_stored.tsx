import { useEffect, useState } from "react";
import { GLOBAL_API_URL } from "../../GLOBAl_API";
import { Post } from "../../assets/PostModel";
import { PostList } from "./Show_Posts";
import { useNavigate } from "react-router-dom";

const API_URL = GLOBAL_API_URL + "posts/";

export function XssPost(){
    const [getPosts, setPosts] = useState([] as Post[]);
    const [getWriteContent, setWriteContent] = useState("");
    const [getWriteTitle, setWriteTitle] = useState("");
    const [getWriteAuthorId, setWriteAuthorId] = useState(2);

    const navigate = useNavigate();

    const deletePost = async (id: number) => {
        const request = await fetch(`${API_URL}${id}`, {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json',
                'Accept': 'application/json'
            }
        });
        if (!request.ok) {
            console.log("something went wrong when tried to delete the post!");
        } else {
            setPosts(getPosts.filter(post => post.id !== id));
            navigate("")
            scrollToPostList();
        }
    };

    const addPost = async (title: string, content: string, authorId: number) => {
        const request = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ title, content, authorId })
        });
        if (!request.ok) {
            console.log("something went wrong when tried to add the post!");
        } else {
            const newPost = await request.json();
            setPosts([...getPosts, newPost]);
        }
    };

    useEffect(() => {
        async function fetchThePosts() {
            const request = await fetch(API_URL, {
                method: 'GET',
                headers: {
                    'Content-type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            if(!request.ok){
                console.log("something went wrong when tried to fetch posts!")
            }
            const response = await request.json();
            setPosts(await response)
        }
        fetchThePosts();
    }, []);

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        addPost(getWriteTitle, getWriteContent, getWriteAuthorId);
        setWriteTitle("");
        setWriteContent("");
    };

    const scrollToPostList = () => {
        const postListElement = document.getElementById("stored-xss");
        if (postListElement) {
            postListElement.scrollIntoView({ behavior: "smooth" });
        }
    };

    return (
        <div className="interactive-container">
            <div>
                <form onSubmit={handleSubmit}>
                    <label htmlFor="postTitle">Title:</label>
                    <input
                        type="text"
                        id="postTitle"
                        value={getWriteTitle}
                        onChange={(e) => setWriteTitle(e.target.value)}
                    />
                    <label htmlFor="postContent">Content:</label>
                    <input
                        type="text"
                        id="postContent"
                        value={getWriteContent}
                        onChange={(e) => setWriteContent(e.target.value)}
                    />
                 
                    <button type="submit">Add Post</button>
                </form>
                <PostList posts={getPosts} onDelete={deletePost} />
            </div>
        </div>
    );
}
//basic payload
// <img src="asd" onerror="alert(document.domain)"/>